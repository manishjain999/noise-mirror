<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Noise Mirror</title>

<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Noise Mirror">

<link rel="apple-touch-icon" href="icon-192.png">

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #0f0f0f;
  color: white;
  font-family: system-ui, -apple-system;
  display: flex;
  align-items: center;
  justify-content: center;
}

.container {
  text-align: center;
  padding: 24px;
}

.emoji {
  font-size: 72px;
}

.title {
  font-size: 28px;
  margin: 12px 0;
}

.hint {
  opacity: 0.7;
  margin-top: 8px;
  font-size: 14px;
}
</style>
</head>

<body>

<div class="container">
  <div class="emoji">ðŸ¤«</div>
  <div class="title">Noise Mirror</div>
  <div class="hint">Tap anywhere to arm</div>
</div>

<script>
/*
 iOS SAFETY RULE:
 - Entire audio graph must be created synchronously
   inside ONE user gesture.
 - No toggles, no stop, no async/await after graph creation.
*/

let armed = false;

document.body.addEventListener('click', () => {
  if (armed) return;
  armed = true;

  const audioContext = new AudioContext();

  navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation: false,
      noiseSuppression: false,
      autoGainControl: false
    }
  }).then(mediaStream => {

    const source = audioContext.createMediaStreamSource(mediaStream);
    const delayNode = audioContext.createDelay(5);
    const gainNode = audioContext.createGain();

    delayNode.delayTime.value = 2.0;   // critical delay
    gainNode.gain.value = 0.8;

    source.connect(delayNode);
    delayNode.connect(gainNode);
    gainNode.connect(audioContext.destination);

    document.querySelector('.hint').textContent = 'Active Â· delayed mirror on';
  });

}, { once: true });
</script>

</body>
</html>
